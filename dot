#!/usr/bin/env bash

set -euo pipefail

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Paths
DOTFILES_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
HOME_DIR="$HOME"
BACKUP_DIR="$HOME/.dotfiles_backup/$(date +%Y%m%d_%H%M%S)"
PACKAGES_DIR="$DOTFILES_DIR/packages"
BREWFILE="$PACKAGES_DIR/Brewfile"
BREWFILE_WORK="$PACKAGES_DIR/Brewfile.work"
BREWFILE_PERSONAL="$PACKAGES_DIR/Brewfile.personal"
HOME_STOW_DIR="$DOTFILES_DIR/home"
BIN_DIR="/usr/local/bin"
ACTIVE_PROFILE_FILE="$DOTFILES_DIR/.active_profile"

# Stow profiles (work and personal are mutually exclusive)
STOW_PROFILES=("common" "work" "personal")

# Helper functions
info() { echo -e "${BLUE}[INFO]${NC} $1"; }
success() { echo -e "${GREEN}[OK]${NC} $1"; }
warn() { echo -e "${YELLOW}[WARN]${NC} $1"; }
error() { echo -e "${RED}[ERROR]${NC} $1"; }

confirm() {
    local prompt="$1"
    local default="${2:-y}"
    local yn
    
    if [[ "$default" == "y" ]]; then
        prompt="$prompt [Y/n]: "
    else
        prompt="$prompt [y/N]: "
    fi
    
    read -r -p "$prompt" yn
    yn="${yn:-$default}"
    
    [[ "$yn" =~ ^[Yy]$ ]]
}

command_exists() {
    command -v "$1" &>/dev/null
}

# Get the Brewfile path for a profile
get_brewfile_for_profile() {
    local profile="$1"
    case "$profile" in
        work)
            echo "$BREWFILE_WORK"
            ;;
        personal)
            echo "$BREWFILE_PERSONAL"
            ;;
        *)
            echo "$BREWFILE"
            ;;
    esac
}

# Parse a single Brewfile to get list of brew packages
get_brew_packages_from_file() {
    local brewfile="$1"
    if [[ -f "$brewfile" ]]; then
        grep "^brew " "$brewfile" 2>/dev/null | sed 's/brew "\([^"]*\)".*/\1/' || true
    fi
}

# Parse a single Brewfile to get list of casks
get_cask_packages_from_file() {
    local brewfile="$1"
    if [[ -f "$brewfile" ]]; then
        grep "^cask " "$brewfile" 2>/dev/null | sed 's/cask "\([^"]*\)".*/\1/' || true
    fi
}

# Get all brew packages for base + active profile
get_brew_packages() {
    local profile
    profile=$(get_active_profile)
    local profile_brewfile
    profile_brewfile=$(get_brewfile_for_profile "$profile")
    
    {
        get_brew_packages_from_file "$BREWFILE"
        [[ -n "$profile" && -f "$profile_brewfile" ]] && get_brew_packages_from_file "$profile_brewfile"
    } | sort -u
}

# Get all cask packages for base + active profile
get_cask_packages() {
    local profile
    profile=$(get_active_profile)
    local profile_brewfile
    profile_brewfile=$(get_brewfile_for_profile "$profile")
    
    {
        get_cask_packages_from_file "$BREWFILE"
        [[ -n "$profile" && -f "$profile_brewfile" ]] && get_cask_packages_from_file "$profile_brewfile"
    } | sort -u
}

# ============================================================================
# INIT COMMAND
# ============================================================================
cmd_init() {
    info "Starting interactive Mac setup..."
    echo ""
    
    # Step 1: Install Homebrew
    echo -e "${BLUE}=== Step 1: Homebrew ===${NC}"
    if command_exists brew; then
        success "Homebrew is already installed"
    else
        if confirm "Install Homebrew?"; then
            info "Installing Homebrew..."
            /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
            
            # Add brew to PATH for Apple Silicon
            if [[ -f "/opt/homebrew/bin/brew" ]]; then
                eval "$(/opt/homebrew/bin/brew shellenv)"
            fi
            success "Homebrew installed"
        else
            warn "Skipping Homebrew installation"
        fi
    fi
    echo ""
    
    # Step 2: Install Homebrew packages (base)
    echo -e "${BLUE}=== Step 2: Homebrew Packages (Base) ===${NC}"
    if [[ -f "$BREWFILE" ]]; then
        info "Found base Brewfile at: $BREWFILE"
        echo "Base packages to install:"
        grep -E "^(brew|cask)" "$BREWFILE" | sed 's/^/  /'
        echo ""
        
        if confirm "Install base packages from Brewfile?"; then
            info "Installing base packages..."
            brew bundle install --file="$BREWFILE"
            success "Base Homebrew packages installed"
        else
            warn "Skipping base Homebrew packages"
        fi
    else
        error "Brewfile not found at $BREWFILE"
    fi
    echo ""
    
    # Step 3: Install mise tools (bun and node)
    echo -e "${BLUE}=== Step 3: Mise (bun & node) ===${NC}"
    if command_exists mise; then
        success "mise is already installed"
        
        if confirm "Install bun@latest and node@lts via mise?"; then
            info "Installing bun@latest..."
            mise use -g bun@latest
            success "bun@latest installed"
            
            info "Installing node@lts..."
            mise use -g node@lts
            success "node@lts installed"
        else
            warn "Skipping mise tools"
        fi
    else
        error "mise is not installed. Install Homebrew packages first."
    fi
    echo ""
    
    # Step 4: Install opencode
    echo -e "${BLUE}=== Step 4: OpenCode ===${NC}"
    if command_exists bun; then
        if confirm "Install opencode via bun?"; then
            info "Installing opencode..."
            bun install -g @anthropics/opencode
            success "opencode installed"
        else
            warn "Skipping opencode"
        fi
    else
        error "bun is not installed. Install mise tools first."
    fi
    echo ""
    
    # Step 5: Stow dotfiles
    echo -e "${BLUE}=== Step 5: Stow Dotfiles ===${NC}"
    if confirm "Stow dotfiles? (will backup existing files)"; then
        cmd_stow
    else
        warn "Skipping dotfile stowing"
    fi
    echo ""
    
    # Step 5b: Install profile-specific packages
    local active_profile
    active_profile=$(get_active_profile)
    if [[ -n "$active_profile" ]]; then
        local profile_brewfile
        profile_brewfile=$(get_brewfile_for_profile "$active_profile")
        
        if [[ -f "$profile_brewfile" ]] && grep -qE "^(brew|cask)" "$profile_brewfile" 2>/dev/null; then
            echo -e "${BLUE}=== Step 5b: Homebrew Packages ($active_profile profile) ===${NC}"
            info "Found $active_profile Brewfile at: $profile_brewfile"
            echo "Profile-specific packages to install:"
            grep -E "^(brew|cask)" "$profile_brewfile" | sed 's/^/  /'
            echo ""
            
            if confirm "Install $active_profile profile packages?"; then
                info "Installing $active_profile packages..."
                brew bundle install --file="$profile_brewfile"
                success "$active_profile Homebrew packages installed"
            else
                warn "Skipping $active_profile Homebrew packages"
            fi
            echo ""
        fi
    fi
    
    # Step 6: Link dot command
    echo -e "${BLUE}=== Step 6: Link dot Command ===${NC}"
    if confirm "Create global 'dot' symlink?"; then
        cmd_link
    else
        warn "Skipping dot symlink"
    fi
    echo ""
    
    # Step 7: SSH key setup (optional)
    echo -e "${BLUE}=== Step 7: SSH Key (Optional) ===${NC}"
    if confirm "Set up SSH key for GitHub/GitLab?" "n"; then
        cmd_ssh
    else
        warn "Skipping SSH key setup (run 'dot ssh' later if needed)"
    fi
    echo ""
    
    success "Setup complete! Run 'dot doctor' to verify installation."
}

# ============================================================================
# DOCTOR COMMAND
# ============================================================================
cmd_doctor() {
    local has_errors=0
    
    info "Checking installation status..."
    echo ""
    
    # Check Homebrew
    echo "Homebrew:"
    if command_exists brew; then
        success "  brew: $(brew --version | head -1)"
    else
        error "  brew: not installed"
        has_errors=1
    fi
    
    # Check brew packages (base Brewfile)
    echo ""
    echo "Homebrew packages (base):"
    if [[ -f "$BREWFILE" ]]; then
        while IFS= read -r pkg; do
            [[ -z "$pkg" ]] && continue
            if brew list "$pkg" &>/dev/null; then
                success "  $pkg: installed"
            else
                error "  $pkg: not installed"
                has_errors=1
            fi
        done < <(get_brew_packages_from_file "$BREWFILE")
    else
        warn "  Brewfile not found at $BREWFILE"
    fi
    
    # Check casks (base Brewfile)
    echo ""
    echo "Homebrew casks (base):"
    if [[ -f "$BREWFILE" ]]; then
        while IFS= read -r cask; do
            [[ -z "$cask" ]] && continue
            if brew list --cask "$cask" &>/dev/null; then
                success "  $cask: installed"
            else
                error "  $cask: not installed"
                has_errors=1
            fi
        done < <(get_cask_packages_from_file "$BREWFILE")
    else
        warn "  Brewfile not found at $BREWFILE"
    fi
    
    # Check profile-specific packages
    local active_profile
    active_profile=$(get_active_profile)
    if [[ -n "$active_profile" ]]; then
        local profile_brewfile
        profile_brewfile=$(get_brewfile_for_profile "$active_profile")
        
        if [[ -f "$profile_brewfile" ]]; then
            # Check profile brew packages
            local profile_brews
            profile_brews=$(get_brew_packages_from_file "$profile_brewfile")
            if [[ -n "$profile_brews" ]]; then
                echo ""
                echo "Homebrew packages ($active_profile):"
                while IFS= read -r pkg; do
                    [[ -z "$pkg" ]] && continue
                    if brew list "$pkg" &>/dev/null; then
                        success "  $pkg: installed"
                    else
                        error "  $pkg: not installed"
                        has_errors=1
                    fi
                done <<< "$profile_brews"
            fi
            
            # Check profile casks
            local profile_casks
            profile_casks=$(get_cask_packages_from_file "$profile_brewfile")
            if [[ -n "$profile_casks" ]]; then
                echo ""
                echo "Homebrew casks ($active_profile):"
                while IFS= read -r cask; do
                    [[ -z "$cask" ]] && continue
                    if brew list --cask "$cask" &>/dev/null; then
                        success "  $cask: installed"
                    else
                        error "  $cask: not installed"
                        has_errors=1
                    fi
                done <<< "$profile_casks"
            fi
        fi
    fi
    
    # Check mise
    echo ""
    echo "Mise:"
    if command_exists mise; then
        success "  mise: $(mise --version)"
        
        # Check bun
        if mise ls bun &>/dev/null && [[ -n "$(mise ls bun 2>/dev/null | grep -v 'No' || true)" ]]; then
            success "  bun: $(bun --version 2>/dev/null || echo 'installed')"
        else
            error "  bun: not installed via mise"
            has_errors=1
        fi
        
        # Check node
        if mise ls node &>/dev/null && [[ -n "$(mise ls node 2>/dev/null | grep -v 'No' || true)" ]]; then
            success "  node: $(node --version 2>/dev/null || echo 'installed')"
        else
            error "  node: not installed via mise"
            has_errors=1
        fi
    else
        error "  mise: not installed"
        has_errors=1
    fi
    
    # Check opencode
    echo ""
    echo "OpenCode:"
    if command_exists opencode; then
        success "  opencode: installed"
    else
        error "  opencode: not installed"
        has_errors=1
    fi
    
    # Check stowed files (common profile)
    echo ""
    echo "Stowed files (common):"
    local common_files=(
        ".config/fish/config.fish"
        ".config/ghostty/config"
        ".config/git/config"
        ".config/starship.toml"
        ".local/bin/coffee"
    )
    for file in "${common_files[@]}"; do
        local target="$HOME/$file"
        if [[ -L "$target" ]]; then
            success "  ~/$file: symlinked"
        elif [[ -f "$target" ]]; then
            warn "  ~/$file: exists but not symlinked"
        else
            error "  ~/$file: missing"
            has_errors=1
        fi
    done
    
    # Check active profile
    echo ""
    echo "Stow profile:"
    local active_profile
    active_profile=$(get_active_profile)
    if [[ -n "$active_profile" ]]; then
        success "  Active profile: $active_profile"
    else
        warn "  No profile active (run 'dot stow' to select)"
    fi
    
    # Check dot symlink
    echo ""
    echo "Dot CLI:"
    if [[ -L "$BIN_DIR/dot" ]]; then
        success "  dot: linked to $BIN_DIR/dot"
    else
        warn "  dot: not linked (run 'dot link')"
    fi
    
    echo ""
    if [[ $has_errors -eq 0 ]]; then
        success "All checks passed!"
        return 0
    else
        error "Some checks failed. Run 'dot init' to fix."
        return 1
    fi
}

# ============================================================================
# STOW COMMAND
# ============================================================================

# Get the currently active profile (work or personal)
get_active_profile() {
    if [[ -f "$ACTIVE_PROFILE_FILE" ]]; then
        cat "$ACTIVE_PROFILE_FILE"
    else
        echo ""
    fi
}

# Set the active profile
set_active_profile() {
    local profile="$1"
    echo "$profile" > "$ACTIVE_PROFILE_FILE"
}

# Unstow a profile
unstow_profile() {
    local profile="$1"
    local profile_dir="$HOME_STOW_DIR/$profile"
    
    if [[ -d "$profile_dir" ]]; then
        info "Unstowing $profile..."
        cd "$DOTFILES_DIR"
        stow -D -v -t "$HOME" -d "$HOME_STOW_DIR" "$profile" 2>/dev/null || true
    fi
}

# Stow a single profile directory
stow_profile() {
    local profile="$1"
    local profile_dir="$HOME_STOW_DIR/$profile"
    
    if [[ ! -d "$profile_dir" ]]; then
        error "Profile directory not found: $profile_dir"
        return 1
    fi
    
    # Check if profile directory has any files
    if [[ -z "$(find "$profile_dir" -type f 2>/dev/null)" ]]; then
        warn "Profile '$profile' is empty, skipping"
        return 0
    fi
    
    info "Stowing $profile profile from $profile_dir"
    
    # Find all files that would be stowed (don't follow symlinks)
    local files_to_stow=()
    while IFS= read -r -d '' file; do
        local relative="${file#$profile_dir/}"
        files_to_stow+=("$relative")
    done < <(find -P "$profile_dir" -type f -print0)
    
    # Backup and remove existing files that conflict
    local backed_up=0
    for file in "${files_to_stow[@]}"; do
        local target="$HOME/$file"
        if [[ -L "$target" ]]; then
            # Only remove symlinks that point into this dotfiles repo
            local link_target
            link_target=$(readlink "$target" 2>/dev/null || true)
            if [[ "$link_target" == *".dotfiles/home/"* ]]; then
                rm "$target"
            fi
        elif [[ -e "$target" ]]; then
            # Skip if the resolved path is inside the dotfiles repo (already managed)
            local resolved_path
            resolved_path=$(cd "$(dirname "$target")" 2>/dev/null && pwd -P)/$(basename "$target")
            if [[ "$resolved_path" == "$DOTFILES_DIR/"* ]]; then
                continue
            fi
            # Backup regular files before removing
            info "Backing up ~/$file"
            mkdir -p "$BACKUP_DIR/$(dirname "$file")"
            cp "$target" "$BACKUP_DIR/$file"
            rm "$target"
            backed_up=1
        fi
    done
    
    if [[ $backed_up -eq 1 ]]; then
        success "Backup created at: $BACKUP_DIR"
    fi
    
    # Run stow
    info "Running stow for $profile..."
    cd "$DOTFILES_DIR"
    stow -v -t "$HOME" -d "$HOME_STOW_DIR" "$profile"
    
    success "$profile profile stowed successfully"
}

cmd_stow() {
    local profile="${1:-}"
    local current_profile
    current_profile=$(get_active_profile)
    
    # If no profile specified, use current or prompt
    if [[ -z "$profile" ]]; then
        if [[ -n "$current_profile" ]]; then
            # Use existing profile
            profile="$current_profile"
            info "Using active profile: $profile"
        else
            # No profile set, prompt interactively
            echo "Available profiles:"
            echo "  1) work"
            echo "  2) personal"
            echo ""
            read -r -p "Select profile (1/2): " choice
            
            case "$choice" in
                1|work)
                    profile="work"
                    ;;
                2|personal)
                    profile="personal"
                    ;;
                *)
                    error "Invalid choice. Use 'work' or 'personal'"
                    return 1
                    ;;
            esac
        fi
    fi
    
    # Validate profile
    if [[ "$profile" != "work" && "$profile" != "personal" ]]; then
        error "Invalid profile: $profile (use 'work' or 'personal')"
        return 1
    fi
    
    # Unstow the other profile if active (work and personal are mutually exclusive)
    if [[ -n "$current_profile" && "$current_profile" != "$profile" ]]; then
        info "Switching from $current_profile to $profile..."
        unstow_profile "$current_profile"
    fi
    
    # Always stow common first
    stow_profile "common"
    
    # Then stow the selected profile
    stow_profile "$profile"
    
    # Save the active profile
    set_active_profile "$profile"
    
    success "All dotfiles stowed with '$profile' profile"
}

# ============================================================================
# LINK COMMAND
# ============================================================================
cmd_link() {
    info "Creating symlink at $BIN_DIR/dot"
    
    # Create bin directory if it doesn't exist
    if [[ ! -d "$BIN_DIR" ]]; then
        info "Creating $BIN_DIR..."
        sudo mkdir -p "$BIN_DIR"
    fi
    
    # Remove existing symlink or file
    if [[ -e "$BIN_DIR/dot" || -L "$BIN_DIR/dot" ]]; then
        warn "Removing existing $BIN_DIR/dot"
        sudo rm "$BIN_DIR/dot"
    fi
    
    # Create symlink
    sudo ln -s "$DOTFILES_DIR/dot" "$BIN_DIR/dot"
    success "Symlink created: $BIN_DIR/dot -> $DOTFILES_DIR/dot"
}

# ============================================================================
# UNLINK COMMAND
# ============================================================================
cmd_unlink() {
    if [[ -L "$BIN_DIR/dot" ]]; then
        info "Removing symlink at $BIN_DIR/dot"
        sudo rm "$BIN_DIR/dot"
        success "Symlink removed"
    else
        warn "No symlink found at $BIN_DIR/dot"
    fi
}

# ============================================================================
# UPDATE COMMAND
# ============================================================================
cmd_update() {
    info "Updating Homebrew packages..."
    
    if ! command_exists brew; then
        error "Homebrew is not installed"
        return 1
    fi
    
    info "Updating Homebrew..."
    brew update
    
    info "Upgrading packages..."
    brew upgrade
    
    info "Upgrading casks..."
    brew upgrade --cask
    
    info "Cleaning up..."
    brew cleanup
    
    success "All packages updated"
}

# ============================================================================
# INSTALL COMMAND
# ============================================================================
cmd_install() {
    if ! command_exists brew; then
        error "Homebrew is not installed"
        return 1
    fi
    
    local active_profile
    active_profile=$(get_active_profile)
    
    # Install base packages
    if [[ -f "$BREWFILE" ]]; then
        info "Installing packages from base Brewfile..."
        local base_packages
        base_packages=$(grep -E "^(brew|cask) " "$BREWFILE" || true)
        if [[ -n "$base_packages" ]]; then
            echo "Packages:"
            echo "$base_packages" | sed 's/^/  /'
            echo ""
            brew bundle install --file="$BREWFILE"
            success "Base packages installed"
        else
            warn "No packages in base Brewfile"
        fi
    else
        error "Base Brewfile not found at $BREWFILE"
        return 1
    fi
    
    # Install profile-specific packages
    if [[ -n "$active_profile" ]]; then
        local profile_brewfile
        profile_brewfile=$(get_brewfile_for_profile "$active_profile")
        
        if [[ -f "$profile_brewfile" ]] && grep -qE "^(brew|cask)" "$profile_brewfile" 2>/dev/null; then
            echo ""
            info "Installing packages from $active_profile Brewfile..."
            echo "Packages:"
            grep -E "^(brew|cask)" "$profile_brewfile" | sed 's/^/  /'
            echo ""
            brew bundle install --file="$profile_brewfile"
            success "$active_profile packages installed"
        fi
    else
        warn "No active profile set. Run 'dot stow' to select a profile for profile-specific packages."
    fi
    
    success "All packages installed"
}

# ============================================================================
# SSH COMMAND
# ============================================================================
cmd_ssh() {
    local email="${1:-$DOT_EMAIL}"
    local key_path="$HOME/.ssh/id_ed25519"
    
    info "Setting up SSH key..."
    
    # Check if key already exists
    if [[ -f "$key_path" ]]; then
        warn "SSH key already exists at $key_path"
        if ! confirm "Do you want to use the existing key?" "y"; then
            error "Aborting. Remove or rename $key_path to generate a new key."
            return 1
        fi
        info "Using existing SSH key"
    else
        # Get email if not provided
        if [[ -z "$email" ]]; then
            read -r -p "Enter your email for SSH key: " email
            if [[ -z "$email" ]]; then
                error "Email is required"
                return 1
            fi
        fi
        
        info "Generating new SSH key for $email..."
        ssh-keygen -t ed25519 -C "$email" -f "$key_path"
        success "SSH key generated at $key_path"
    fi
    
    # Start ssh-agent if not running
    info "Starting ssh-agent..."
    eval "$(ssh-agent -s)"
    
    # Create or update SSH config for macOS keychain
    local ssh_config="$HOME/.ssh/config"
    local keychain_config="Host *
  AddKeysToAgent yes
  UseKeychain yes
  IdentityFile $key_path"
    
    if [[ -f "$ssh_config" ]]; then
        if grep -q "UseKeychain yes" "$ssh_config"; then
            info "SSH config already configured for keychain"
        else
            info "Adding keychain config to existing SSH config..."
            echo "" >> "$ssh_config"
            echo "$keychain_config" >> "$ssh_config"
            success "Updated $ssh_config"
        fi
    else
        info "Creating SSH config..."
        mkdir -p "$HOME/.ssh"
        echo "$keychain_config" > "$ssh_config"
        chmod 600 "$ssh_config"
        success "Created $ssh_config"
    fi
    
    # Add key to keychain
    info "Adding SSH key to macOS keychain..."
    ssh-add --apple-use-keychain "$key_path"
    success "SSH key added to keychain"
    
    # Display public key
    echo ""
    info "Your public key (copy this to GitHub/GitLab):"
    echo ""
    cat "${key_path}.pub"
    echo ""
    
    # Offer to copy to clipboard
    if confirm "Copy public key to clipboard?"; then
        pbcopy < "${key_path}.pub"
        success "Public key copied to clipboard"
    fi
}

# ============================================================================
# ADD COMMAND
# ============================================================================
cmd_add() {
    local pkg_type="${1:-}"
    local pkg_name="${2:-}"
    local target_profile="${3:-}"
    
    if [[ -z "$pkg_type" || -z "$pkg_name" ]]; then
        error "Usage: dot add <brew|cask> <package> [profile]"
        echo "  profile: base (default), work, or personal"
        return 1
    fi
    
    if ! command_exists brew; then
        error "Homebrew is not installed"
        return 1
    fi
    
    # Determine target Brewfile
    local target_brewfile
    case "$target_profile" in
        work)
            target_brewfile="$BREWFILE_WORK"
            ;;
        personal)
            target_brewfile="$BREWFILE_PERSONAL"
            ;;
        base|"")
            target_brewfile="$BREWFILE"
            target_profile="base"
            ;;
        *)
            error "Unknown profile: $target_profile (use 'base', 'work', or 'personal')"
            return 1
            ;;
    esac
    
    # Check if package exists in any Brewfile
    local already_exists=""
    if grep -q "^$pkg_type \"$pkg_name\"" "$BREWFILE" 2>/dev/null; then
        already_exists="base Brewfile"
    elif grep -q "^$pkg_type \"$pkg_name\"" "$BREWFILE_WORK" 2>/dev/null; then
        already_exists="work Brewfile"
    elif grep -q "^$pkg_type \"$pkg_name\"" "$BREWFILE_PERSONAL" 2>/dev/null; then
        already_exists="personal Brewfile"
    fi
    
    if [[ -n "$already_exists" ]]; then
        warn "$pkg_name is already in $already_exists"
        return 0
    fi
    
    case "$pkg_type" in
        brew)
            info "Installing $pkg_name..."
            if brew install "$pkg_name"; then
                success "$pkg_name installed"
                
                info "Adding $pkg_name to $target_profile Brewfile..."
                add_to_brewfile "brew" "$pkg_name" "$target_brewfile"
                success "$pkg_name added to $target_profile Brewfile"
            else
                error "Failed to install $pkg_name"
                return 1
            fi
            ;;
        cask)
            info "Installing cask $pkg_name..."
            if brew install --cask "$pkg_name"; then
                success "$pkg_name installed"
                
                info "Adding $pkg_name to $target_profile Brewfile..."
                add_to_brewfile "cask" "$pkg_name" "$target_brewfile"
                success "$pkg_name added to $target_profile Brewfile"
            else
                error "Failed to install $pkg_name"
                return 1
            fi
            ;;
        *)
            error "Unknown package type: $pkg_type (use 'brew' or 'cask')"
            return 1
            ;;
    esac
}

add_to_brewfile() {
    local pkg_type="$1"
    local pkg_name="$2"
    local target_file="${3:-$BREWFILE}"
    local temp_file
    temp_file=$(mktemp)
    
    # Create file if it doesn't exist
    if [[ ! -f "$target_file" ]]; then
        touch "$target_file"
    fi
    
    # Extract header (cask_args line) - only for base Brewfile
    local header=""
    if [[ "$target_file" == "$BREWFILE" ]]; then
        header=$(grep "^cask_args" "$target_file" || true)
    fi
    
    # Extract existing brew and cask entries
    local brews casks
    brews=$(grep "^brew " "$target_file" 2>/dev/null || true)
    casks=$(grep "^cask " "$target_file" 2>/dev/null || true)
    
    # Add new entry to appropriate list
    if [[ "$pkg_type" == "brew" ]]; then
        brews=$(echo -e "$brews\nbrew \"$pkg_name\"" | grep -v "^$" | sort -u)
    else
        casks=$(echo -e "$casks\ncask \"$pkg_name\"" | grep -v "^$" | sort -u)
    fi
    
    # Rebuild Brewfile
    {
        [[ -n "$header" ]] && echo "$header" && echo ""
        [[ -n "$brews" ]] && echo "$brews"
        [[ -n "$brews" && -n "$casks" ]] && echo ""
        [[ -n "$casks" ]] && echo "$casks"
    } > "$temp_file"
    
    mv "$temp_file" "$target_file"
}

# ============================================================================
# REMOVE COMMAND
# ============================================================================
cmd_remove() {
    local pkg_type="${1:-}"
    local pkg_name="${2:-}"
    
    if [[ -z "$pkg_type" || -z "$pkg_name" ]]; then
        error "Usage: dot remove <brew|cask> <package>"
        return 1
    fi
    
    if ! command_exists brew; then
        error "Homebrew is not installed"
        return 1
    fi
    
    # Find which Brewfile contains the package
    local target_brewfile=""
    local target_profile=""
    if grep -q "^$pkg_type \"$pkg_name\"" "$BREWFILE" 2>/dev/null; then
        target_brewfile="$BREWFILE"
        target_profile="base"
    elif grep -q "^$pkg_type \"$pkg_name\"" "$BREWFILE_WORK" 2>/dev/null; then
        target_brewfile="$BREWFILE_WORK"
        target_profile="work"
    elif grep -q "^$pkg_type \"$pkg_name\"" "$BREWFILE_PERSONAL" 2>/dev/null; then
        target_brewfile="$BREWFILE_PERSONAL"
        target_profile="personal"
    fi
    
    if [[ -z "$target_brewfile" ]]; then
        warn "$pkg_name is not in any Brewfile"
        return 0
    fi
    
    case "$pkg_type" in
        brew)
            info "Uninstalling $pkg_name..."
            brew uninstall "$pkg_name" 2>/dev/null || true
            success "$pkg_name uninstalled"
            
            info "Removing $pkg_name from $target_profile Brewfile..."
            remove_from_brewfile "brew" "$pkg_name" "$target_brewfile"
            success "$pkg_name removed from $target_profile Brewfile"
            ;;
        cask)
            info "Uninstalling cask $pkg_name..."
            brew uninstall --cask "$pkg_name" 2>/dev/null || true
            success "$pkg_name uninstalled"
            
            info "Removing $pkg_name from $target_profile Brewfile..."
            remove_from_brewfile "cask" "$pkg_name" "$target_brewfile"
            success "$pkg_name removed from $target_profile Brewfile"
            ;;
        *)
            error "Unknown package type: $pkg_type (use 'brew' or 'cask')"
            return 1
            ;;
    esac
}

remove_from_brewfile() {
    local pkg_type="$1"
    local pkg_name="$2"
    local target_file="${3:-$BREWFILE}"
    local temp_file
    temp_file=$(mktemp)
    
    # Remove the matching line
    grep -v "^$pkg_type \"$pkg_name\"" "$target_file" > "$temp_file" || true
    
    # Remove any double blank lines that might result
    cat -s "$temp_file" > "$target_file"
    rm -f "$temp_file"
}

# ============================================================================
# HELP COMMAND
# ============================================================================
cmd_help() {
    cat <<EOF
dot - Mac dotfiles and setup manager

Usage: dot <command> [options]

Commands:
  init                  Interactive setup - installs everything step by step
  doctor                Check installation status and report any issues
  stow [profile]        Stow dotfiles (uses active profile, or prompts if none)
  link                  Create 'dot' symlink in $BIN_DIR
  unlink                Remove 'dot' symlink from $BIN_DIR
  install               Install packages from Brewfiles (base + active profile)
  update                Update all Homebrew packages
  add <brew|cask> <pkg> [profile]   Install package and add to Brewfile
  remove <brew|cask> <pkg>          Uninstall package and remove from Brewfile
  ssh [email]           Generate SSH key and add to macOS keychain
  help                  Show this help message

Profiles:
  Dotfiles (home/):
    common              Always applied (fish, ghostty, starship, etc.)
    work                Work-specific configs (mutually exclusive with personal)
    personal            Personal configs (mutually exclusive with work)

  Brewfiles (packages/):
    Brewfile            Base packages (always installed)
    Brewfile.work       Work-specific packages
    Brewfile.personal   Personal-specific packages

Environment Variables:
  DOT_EMAIL    Default email for SSH key generation

Examples:
  dot init                    # Set up a new Mac
  dot doctor                  # Verify installation
  dot stow                    # Stow dotfiles (uses active profile or prompts)
  dot stow work               # Stow common + work profile
  dot stow personal           # Stow common + personal profile
  dot install                 # Install all packages from Brewfiles
  dot update                  # Upgrade all packages
  dot add brew htop           # Install htop to base Brewfile
  dot add brew kubectl work   # Install kubectl to work Brewfile
  dot add cask slack personal # Install Slack to personal Brewfile
  dot remove brew htop        # Uninstall htop (auto-detects Brewfile)
  dot remove cask slack       # Uninstall Slack (auto-detects Brewfile)
  dot ssh                     # Generate SSH key (prompts for email)
  dot ssh user@example.com    # Generate SSH key with email

EOF
}

# ============================================================================
# MAIN
# ============================================================================
main() {
    local cmd="${1:-help}"
    
    case "$cmd" in
        init)
            cmd_init
            ;;
        doctor)
            cmd_doctor
            ;;
        stow)
            cmd_stow "${2:-}"
            ;;
        link)
            cmd_link
            ;;
        unlink)
            cmd_unlink
            ;;
        install)
            cmd_install
            ;;
        update)
            cmd_update
            ;;
        add)
            cmd_add "${2:-}" "${3:-}" "${4:-}"
            ;;
        remove)
            cmd_remove "${2:-}" "${3:-}"
            ;;
        ssh)
            cmd_ssh "${2:-}"
            ;;
        help|--help|-h)
            cmd_help
            ;;
        *)
            error "Unknown command: $cmd"
            echo ""
            cmd_help
            exit 1
            ;;
    esac
}

main "$@"
